using TestEnv; TestEnv.activate()
using NCTSSoS, CSV, DataFrames, Test, MosekTools

λd = [-0.2071068, -0.2508754, -0.2990381, -0.4353342, -0.3003638, -0.2878683, -0.5916501, -0.4652428, -0.4561079, -0.4877093, -0.4496279, -0.4571068,
    -0.3754473, -0.6234571, -0.5460735, -0.6047986, -0.6033789, -0.6483073,
    -0.6403143, -0.4920635, -0.5698209, -0.5738173, -0.4135530, -0.6226313,
    -0.5350117, -0.6249079, -0.4388685, -0.4868868, -0.4699127, -0.6172035,
    -0.6078638, -0.4785634, -0.6107654, -0.5364942, -0.5372394, -0.4666943,
    -0.5182900, -0.6218612, -0.6386102, -0.5936813, -0.6213203, -0.6603444,
    -0.6488905, -0.4488256, -0.4019248, -0.4877093, -0.6052228, -0.4490163,
    -0.6962822, -0.8831381, -0.6890694, -0.6051510, -0.4898631, -0.6655582,
    -0.8927018, -0.6243153]

opt_vals = [ -0.2071068, -0.2508756, -0.2990381, -0.4353342, -0.3003638,-0.2878683,-0.5916501, -0.4652428, -0.4561079,
-0.4877093, -0.4496279, -0.4571068, -0.3754473, -0.6234571, -0.5460735,
-0.6047986, -0.6033789, -0.6483073, -0.6403143, -0.4920635, -0.5698209,
-0.5738173, -0.4135530, -0.6226313, -0.5350117, -0.6249079, -0.4388685,
-0.4868868, -0.4699126, -0.6172035, -0.6078638, -0.4785634, -0.6107654,
-0.5364942, -0.5372394, -0.4666943, -0.5182900, -0.6218611, -0.6386102,
-0.5936813, -0.6213203, -0.6603444, -0.6488905, -0.4488256, -0.4019248,
-0.4877093, -0.6052228, -0.4490163, -0.6962822, -0.8831381, -0.6890694,
-0.6051510, -0.4898631, -0.6655582, -0.8927018,	 -0.6243153]

d = [1, 3, 3, 3, 3, 3, 1, 3, 3, 2, 3, 3, 2, 3, 2, 2, 2, 2, 2, 2, 2, 2, 3, 3, 3, 3, 3, 3, 3,
    2, 2, 3, 2, 3, 3, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 2, 3, 3, 3, 3, 3, 3, 3, 2, 3]

using DataFrames
data = CSV.read("test/extracted_data.csv", DataFrame)
ms = data[:,2]
ns = data[:,3]
equations = data[:,4]

i = 2
@ncpolyvar X[1:ms[i]] Y[1:ns[i]] 
p = 1.0 * eval(Meta.parse(equations[i]))
pop = polyopt(p, comm_gps=[X, Y], is_projective=true)

solver_config = SolverConfig(optimizer=Mosek.Optimizer, mom_order=d[i])

res = cs_nctssos(pop, solver_config)
λd[i]
opt_vals[i]
@test res.objective ≈ λd[i] atol=1e-6

for i in eachindex(ms)[1:7]
	@ncpolyvar X[1:ms[i]] Y[1:ns[i]] 
	p = 1.0 * eval(Meta.parse(equations[i]))
	pop = polyopt(p,comm_gps=[X,Y],is_projective=true)

    solver_config = SolverConfig(optimizer=Mosek.Optimizer, mom_order=d[i])

	res = cs_nctssos(pop, solver_config)
	@test res.objective ≈ λd[i] atol=1e-6
end
